
clear
[task_info,supPath] = loadDBAndSpecifyDataPaths('Vermis');

PLOT_CELL = false;

req_params.grade = 7;
req_params.cell_type = {'PC ss','CRB','SNR','BG msn'};
req_params.task = 'pursuit_8_dir_75and25|saccade_8_dir_75and25';
req_params.ID = [4004,4005,4012,4019,4048,4055,4055,4062,4062,4077,4078,4079,4081,4081,4086,4094,4112,4123,4135,4154,4156,4161,4162,4164,4164,4165,4173,4175,4178,4178,4179,4184,4184,4190,4208,4208,4143,4209,4209,4212,4213,4223,4223,4226,4235,4236,4237,4237,4238,4239,4239,4240,4243,4244,4255,4255,4272,4275,4287,4294,4300,4305,4305,4307,4307,4321,4323,4328,4328,4339,4343,4351,4359,4362,4366,4369,4369,4379,4384,4384,4389,4390,4390,4391,4395,4396,4397,4400,4418,4419,4424,4425,4426,4426,4426,4427,4428,4429,4429,4432,4434,4435,4437,4446,4446,4452,4455,4456,4457,4464,4479,4479,4480,4482,4510,4514,4518,4521,4525,4526,4526,4533,4534,4535,4537,4537,4542,4566,4569,4569,4570,4570,4577,4580,4582,4582,4592,4592,4594,4599,4602,4604,4604,4605,4606,4606,4610,4610,4622,4622,4623,4624,4624,4625,4625,4626,4640,4642,4643,4643,4645,4646,4649,4649,4652,4654,4654,4658,4658,4659,4661,4661,4662,4663,4663,4672,4675,4677,4678,4679,4679,4680,4680,4681,4681,4682,4682,4685,4687,4688,4688,4689,4689,4690,4690,4698,4699,4700,4700,4701,4701,4702,4702,4707,4707,4709,4713,4733,4735,4750,4751,4753,4753,4754,4754,4758,4777,4778,4778,4779,4779,4782,4785,4785,4790,4790,4791,4791,4792,4792,4793,4797,4803,4803,4806,4806,4810,4814,4820,4821,4821,4826,4827,4829,4830,4832,4832,4833,4833,4835,4839,4843,4846,4846,4849,4849,4854,4857,4859,4862,4864,4864,4865,4869,4869,4874,4875,4878,4878,4879,4883,4886,4886,4887,4888,4889,4894,4894,4911,4912,4915,4929,4969,4970,4970,4972,4973,4986,4998,5000,5000,5007,5010,5010,5013,5013,5017,5018,5018,5020,5021,5022,5022,5025,5027,5031,5031,5032,5033,5033,5035,5035,5036,5037,5040,5041,5042,5042,5043,5049,5049,5051,5051,5052,5052,5059,5060,5063,5065,5065,5067,5068,5071,5071,5072,5072,5074,5075,5075,5076,5077,5077,5081,5084,5085,5088,5088,5089,5091,5091,5092,5093,5093,5094,5095,5095,5097,5098,5098,5099,5100,5101,5101,5104,5105,5110,5115,5123,5123,5126,5126,5127,5127,5129,5130,5134,5134,5156,5159,5160,5183,5188,5193,5195,5198,5215,5230,5236,5236,5241,5241,5244,5247,5249,5251,5251,5252,5252,5262,5262,5263,5266,5268,5269,5272,5272,5281,5285,5287,5287,5288,5298,5298,5300,5307,5307,5318,5318,5319,5319,5320,5320,5321,5326,5326,5340,5342,5343,5348,5350,5351,5352,5357,5358,5358,5361,5361,5366,5367,5370,5376,5381,5381,5381,5390,5391,5392,5392,5393,5394,5413,5418,5418,5423,5423,5426,5434,5440,5440,5452,5459,5460,5455,5455,5458,5458,5463,5463,5485,5486,5487,5488,5488,5489,5499,5501,5503,5505,5506,5507,5511,5513,5514,5516,5518,5523,5528,5528,5529,5529,5531,5532,5539,5540,5541,5544,5547,5552,5553,5554,5557,5557,5557,5558,5558,5560,5560,5562,5562,5563,5568,5568,5569,5577,5582,5582,5583,5583,5588,5590,5590,5591,5600,5601,5602,5602,5603,5603,5606,5607,5612,5613,5613,5614,5616,5619,5619,5620,5620,5620,5620,5625,5625,5630,5632,5635,5636,5636,5638,5638,5639,5639,5641,5641,5647,5649,5658,5661,5662,5663,5664,5664,5666,5666,5668,5668,5670,5670,5682,5682,5683,5684,5685,5685,5686,5688,5688,5689,5690,5691,5691,5693,5698,5699,5699,5700,5701,5702,5703,5707,5708,5708,5711,5716,5716,5719,5722,5722,5738,5739,5739,5741,5741,5742,5742,5744,5744,5746,5747,5748,5749,5751,5751,5752,5752,5757,5757,5758,5758,5760,5760,5763,5769,5769,5770,5780,5780,5788,5790,5793,5794,5795,5799,5799,5800,5800,5801,5801,5804,5805,5807,5809,5810,5811,5815,5816,5818,5819,5820,5822,5823,5824,5825,5825,5826,5828,5828,5829,5830,5831,5832,5832,5833,5834,5835,5836,5837,5838,5838,5839,5840,5841,5842,5843,5844,5846,5847,5849,5849,5850,5851,5853,5854,5855,5861];
%req_params.task = 'rwd_direction_tuning';

req_params.num_trials = 100;
req_params.remove_question_marks = 1;

raster_params.align_to = 'targetMovementOnset';

lines = findLinesInDB (task_info, req_params);
cells = findPathsToCells (supPath,task_info,lines);

cellType = cell(length(cells),1);

list = [];
for ii = 1:length(cells)
    
    data = importdata(cells{ii});
    cellType{ii} = task_info(lines(ii)).cell_type;
    cellID(ii) = data.info.cell_ID;  
    
    [effectSizes(ii,:),ts] = effectSizeInTimeBin...
        (data,raster_params.align_to,'prevOut',false);
    
    if PLOT_CELL
        
        flds = fields(effectSizes);
        sgtitle([task_info(lines(ii)).cell_type num2str(data.info.cell_ID)])
        for f = 1:length(flds)
            
            subplot(1,length(flds),f); hold on
                        
            plot(ts,[effectSizes(ii,:).(flds{f})])
            xlabel(['time from ' raster_params.align_to ' (ms)' ])
            title(flds{f})
        end
        
        pause
        arrayfun(@cla,findall(0,'type','axes'))

    end
    
end

%%

flds = fields(effectSizes);


h = cellID<inf

figure
for f = 1:length(flds)
    
    subplot(1,length(flds),f); hold on
    
    for i = 1:length(req_params.cell_type)
        
        indType = find(strcmp(req_params.cell_type{i}, cellType) & h');
        
        a = reshape([effectSizes(indType,:).(flds{f})],length(indType),length(ts));
        
        errorbar(ts,nanmean(a,1), nanSEM(a,1))
        xlabel(['time from ' raster_params.align_to ' (ms)' ])
        title(flds{f}, 'Interpreter', 'none')
        
    end
    legend(req_params.cell_type)
end

